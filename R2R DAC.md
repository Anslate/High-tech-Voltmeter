# R-2R数模转换

## 前言之前
虽说知识不嫌多，但效率更重要，不要死磕在一处，善用Github的目录！  
因为插图是白底的，所以建议白底黑字观看  
Github对于KaTex的支持不佳（也有可能是我的问题），某些地方会出现一些排版问题，建议下载下来观看
## 前言
这是一篇关于R-2R梯形数字模拟转换器（以下简称R-2R）的文章.  
我的 `High-tech Voltmeter` 项目使用到了R-2R，算是PWM的替代品（要是有PWM的话谁用R-2R啊）.  
但是关于R-2R的中文资料质量不佳，于是就有了此文章.  
我最开始是不想写的，直接复制一篇标个转载算了.  
但在网上找了一圈，但这些中文资料，嗯，说难听点就是在垃圾桶里找资料，干脆自己写吧（无意冒犯）.  
~~引用和参考？那是啥？~~

## 基础复习
_**（以下所写的仅是是本文需要的知识，想要深入了解请自行查阅资料并学习）**_  
### [电压分配定则](https://en.wikipedia.org/wiki/Voltage_divider)
在初中，我们都学过欧姆定律$I=\frac{U}{R}$，然后老师会教我们推导出电压分配定则。  
那我们不妨再推导一次，复习一下，活络下脑子.  
这是一个很简单的串联电路：  
<img alt="Image" src=".\Images\1.svg">  
其总电压为$U_0$，两个电阻阻值分别为$R_1$和$R_2$.  
这样可以轻松的算出电流 $I=\frac{U_0}{R_1+R_2}$.  
从而得出电阻$R_1$分配到的电压$U_1=IR_1=\frac{U_0R_1}{R_1+R_2}$.  
此时可以整理出$U_1$，$U_2$与$U_0$，$R_1$，$R_2$的关系：  
$U_1=\frac{U_0R_1}{R_1+R_2}$  
$U_2=\frac{U_0R_2}{R_1+R_2}$  
这就是电压分配定则.  
实际中会遇到更多串联电阻，此时可以用整体思想将其化简.  
_（说句题外话，大部分中文资料上对于电压分配定则的解释都是 **在串联电路中，各负载分到的电压与其阻抗成正比关系** 但是根据推导式来看好像有误.）_

### [电压源](https://en.wikipedia.org/wiki/Voltage_source)  
<img alt="Image" src=".\Images\2.svg">

我们在生活中见到的电源大多数都是电压源，例如电池，市电.  
理想电压源有许多性质：  
1. 两端的电压保持不变，而电流会改变.  
2. 内阻为0.  
3. ......

但因为各种因素，没有真正的电压源是理想的.  
就把电压源当成普通的电源就行.

### [电流源](https://en.wikipedia.org/wiki/Current_source)
<img alt="Image" src=".\Images\3.svg">

生活中很少能见到电流源，并且R-2R也用不上，所以我也不详细解释，把他当作一个模型就好.  
理想电流源有许多性质，且大多数与理想电压源相反：  
1. 其电流保持不变，而两端的电压会改变.  
2. 内阻为无穷大.  
3. ......

但因为各种因素，没有真正的电流源是理想的.   
还有个违背直觉的特性，虽然没什么用，但我还是想说一说：  
电流源不能开路，如果开路，意味着电流为0，与其性质相悖（现实中的电流源开路会因为电压过大而损坏元器件）.

### 电阻的化简
两个电阻串联：$R_总=R_1+R_2$  
两个电阻并联：$R_总=\frac{R_1R_2}{R_1+R_2}$  
可以自己通过欧姆定律算出来，这里就不赘述了.

## 理论支撑
_**（以下所写的仅是是本文需要的知识，想要深入了解请自行查阅资料并学习）**_  
### [戴维南定理](https://en.wikipedia.org/wiki/Th%C3%A9venin%27s_theorem)
戴维南定理（Thevenin's theorem）又称等效电压源定律，由 [Hermann von Helmholtz](https://en.wikipedia.org/wiki/Hermann_von_Helmholtz) 在1853年以及 [Léon Charles Thévenin](https://en.wikipedia.org/wiki/L%C3%A9on_Charles_Th%C3%A9venin) 在1883年分别独立提出.  
其内容为 **对于任何仅包含电压源，电流源和电阻的线性电网，都可以等效为一个电压源$U_{th}$与一个串联电阻$R_{th}$.**  
当然，电压源和电流源都是独立的 _（如果你不知道什么是**独立**电压、电流源的话，就当作是我上面写的那种，无论外界条件变化，电压源的电压永远不变，电流源的电流永远不变.）_  
并且得要有两个端点（这应该比较好理解，就是这个电路需要有两个端点进行输出，比如下图的空心圆）   
关于戴维南定理的证明以及推导请自行了解，我这边只把它当作工具使用.  

废话了这么多，这定理能干什么？  
<img alt="Image" src=".\Images\4.svg">  
这是一个电路，而且还比较复杂，但它却只由电压源与电阻组成，所以它是在戴维南定理的适用范围之内的.  
那就可以通过某些魔法，把它变成一个电压源与一个串联电阻：  
<img alt="Image" src=".\Images\5.svg">   
我们称这种电路为 **戴维南等效电路（Thévenin equivalent）**  
先不说有没有用，反正十分赏心悦目  
问题来了，怎么施这个“魔法”呢？  
分为两步：  
- 计算等效电压源  
- 计算等效电阻  

#### 计算等效电压源

不分先后顺序，但我更喜欢先计算等效电压源.   
为了方便，我在电路图的节点上标了字母，若无特殊说明，电压测量的负极皆为GND节点  
<img alt="Image" src=".\Images\6.svg">    
_例如：$U_A$就是GND节点到A节点之间的电压，$U_{AB}$就是A节点到B节点之间的电压._  
接下来就是等效电压$U_{th}$计算过程：  
$U_{th}=U_D=U_B=\frac{U_AR_B}{R_{AB}+R_B}=\frac{U_0(R_2+R_3)}{R_1+R_2+R_3}=\frac{1.5V*(1Ω+1Ω)}{2Ω+1Ω+1Ω}=0.75V$  
我也提一嘴电流源，因为有回路（没有回路就构建不了线性电网），所以电流源也是有电压值的，而其等效电压就是两个输出端开路时的电压（消歧义：等效电压是输出端的电压，不是电流源的电压），自行理解以下，理解不了也没事，反正R-2R用不到电流源

#### 计算等效电阻

接下来就该是等效电阻$U_{th}$，在计算等效电阻时，先要将电压源和电流源换算成电阻，而阻值就是其内阻.  
说人话就是用导线代替电压源，用开路代替电流源.  
所以原电路图就成了这个样子：    
<img alt="Image" src=".\Images\7.svg">   
此时等效电阻$R_{th}=R_D$.  
这样计算起来就方便了，给出过程:  
$R_{th}=R_D=R_B+R_{BD}=\frac{R1(R2+R3)}{R1+R2+R3}+R4=\frac{2Ω*(1Ω+1Ω)}{2Ω+1Ω+1Ω}+1Ω=2Ω$  
此时等效电压源$U_{th}$和等效电阻$R_{th}$都算出来了，那么其等效电路也就水落石出了.  
<img alt="Image" src=".\Images\5.svg"> 

因为R-2R没有电流源，所以电流源也就一笔带过了，还是那句话“以下所写的仅是是本文需要的知识，想要深入了解请自行查阅资料并学习”.  
当然，在实践中的话，一个万用表，一个计算器和一张草稿纸 ~~（足够聪慧的大脑也行）~~ ，就可以直接测量出结果，不用上面这么繁琐的步骤了，但精确度就一言难尽了.

## R-2R的构建推导
现在呢，正式开始写R-2R数模转换器.  
你以为这是重点，其实，已经结束啦！  
R-2R就是戴维南定理的实际应用，特别容易懂.  
所以我就多说些废话啦.  

R-2R全称 **R-2R梯形数字模拟转换器(R-2R ladder)**  
这个“梯形”不是几何中的“梯形”，而是“梯子形状”，看下电路图就知道为什么这么称呼了：  
<img alt="Image" src=".\Images\8.svg">  
_（图中的公共接地省略，以下插图皆是）_  
勉勉强强算个梯子吧  
这玩意是个4位的R-2R，有$U_0$~$U_3$四个数字输入和$U_{out}$一个模拟输出  
因为是数字输入是4位，所以模拟输出一共是16个等级（$2^4=16$）

以下举例中高电平默认5V，低电平默认接地.  
假如输入0000，也就是$U_0$~$U_3$全都接地  
那么显而易见，$U_{out}$为0V  
假如输入1111，也就是$U_0$~$U_3$全都接5V  
那么其$U_{out}$输出为4.6875V  
为什么输出为4.6875V呢，我们后面会说，总之，我先给出结论：
|数字输入|$U_0$|$U_1$|$U_2$|$U_3$|模拟输出(V)|
|:-:|:-:|:-:|:-:|:-:|:-:|
|0000|0|0|0|0|0
|0001|0|0|0|1|0.3125|
|0010|0|0|1|0|0.6250|
|0011|0|0|1|1|0.9375|
|0100|0|1|0|0|1.2500|
|0101|0|1|0|1|1.5625|
|0110|0|1|1|0|1.8750|
|0111|0|1|1|1|2.1875|
|1000|1|0|0|0|2.5000|
|1001|1|0|0|1|2.8125|
|1010|1|0|1|0|3.1250|
|1011|1|0|1|1|3.4375|
|1100|1|1|0|0|3.7500|
|1101|1|1|0|1|4.0625|
|1110|1|1|1|0|4.3750|
|1111|1|1|1|1|4.6875|

那么现在正式开始推导R-2R的奇妙之处，也就是关于R-2R的魔法  
可以拿张纸，拿支笔出来画画，效果更好.  
首先我们先看最开始的两个电阻：  
<img alt="Image" src=".\Images\9.svg">  
根据戴维南定理，其等效电阻$R_{th}$大小为R，等效电压$U_{th}$大小为$\frac{U_3}{2}$  
我们将等效电路连回原电路图中，发现可以化简，两个阻值为R的电阻合并成了一个阻值为2R的电阻：  
<img alt="Image" src=".\Images\10.svg">  
于是我们不难发现，好像有些眼熟？  
是的，就是这样，一直推导下去，就能推导出$U_{out}$的公式来（此处就自己动手画图算算吧，只可意会不可言传）：  
$U_{out}=\frac{U_0}{2}+\frac{U_1}{4}+\frac{U_2}{8}+\frac{U_3}{16}$  
（其实仔细看看就是每一位的电压乘上每一位的权重）  
现在知道为什么输入1111输出为4.6875V了吧  
恭喜你，理解了R-2R的工作原理！  
那么文章到这样也就告一段落了，谢谢各位！

## 回顾&后记
洋洋洒洒写了几千字，复习了一下初中的电学知识，也介绍了戴维南定理  
终于补上了R-2R中文文档的空缺.   
写之前以为很轻松，但又要文章，又要插图，漫漫的写了一周多.
终于不是重复造车轮了.  
这个暑假也算没有白白浪费.

## 版权相关
要复制请提供出处以及作者（作者就是我本人 **Anslate** ），不能商用.  
本文章的文字以及插图所有权归属于：Anslate Anslate2020@outlook.com.  
<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可.  